version: 2.1

jobs:
  build:
    docker:
      - image: cimg/base:2021.04

    environment:
      REGISTRY: ghcr.io
      APP_NAME: sieve
      IMAGE_NAME: $REGISTRY/$CR_USERNAME/$APP_NAME:latest

    steps:
      - checkout

      - setup_remote_docker:
          version: 20.10.14
          docker_layer_caching: true

      - run:
          name: check docker compose version
          command: |
            docker-compose -v

      - run:
          name: build
          command: |
            docker-compose -f "./docker/docker-compose.yml" up -d --build

      - run:
          name: check containers
          command: |
            docker ps

      - run:
          name: shut down
          command: |
            docker-compose -f "./docker/docker-compose.yml" down

      - run:
          name: tag images
          command: |
            docker image tag $APP_NAME:latest $IMAGE_NAME

      - run:
          name: check containers
          command: |
            docker ps

      - run:
          name: ghcr login
          command: |
            echo $CR_PAT | docker login $REGISTRY -u $CR_USERNAME --password-stdin

      - run:
          name: push to registry
          command: |
            docker push $IMAGE_NAME

      - run:
          name: final step
          command: |
            echo "FINISHED!"
